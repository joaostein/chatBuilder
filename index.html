<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="http://chatbuilder.hackreactor.com/ChatBuilder.js"></script>
  </head>
  <body>
    <script>
      Chat.guide.start();
      
      delete Chat.display;
      delete Chat.fetch;
      delete Chat.send;

      jQuery(function ($) {

        var coreChat = {

          state: "off",
          fetch: function (fn) {
            $.ajax({
              url: "https://api.parse.com/1/classes/chats",
              data: {
                 order: 'createdAt',
                 limit: 10
              },
              type: "GET"
            }).done(function(data) {
              var messages = [];
              for (var i = 0, len = data.results.length; i < len; i++) {
                messages.push(data.results[i].text);
              }

              return fn(messages);
            });
          },

          send: function (message) {
            var data = JSON.stringify({text: message});
            $.ajax({
              url: "https://api.parse.com/1/classes/chats",
              data: data,
              type: "POST"
            }).done(function(data) {
              
            });
          },

          display: function (message) {
            $("<li></li>", {
              text: message
            }).appendTo($(".messages"));

            if (this.state === "on") {
              $(".messages").find("li").first().remove();
            }
          },
        };

        var myChat = {

          init: function () {
            this.fetchInitialData();
            this.sendMessageButton();
            this.refresh();
          },

          fetchInitialData: function () {
            this.fetch(function (messages) {
              for (var i = 0, len = messages.length; i < len; i++) {
                myChat.display(messages[i]);
              }

              myChat.state = "on";
              myChat.oldMessageArray = messages;
            });
          },

          refresh: function () {
            setInterval(function () {
              this.fetch(function (messages) {
                $(".messages li").each(function (i) {
                  if ($(this).text() !== messages[i]) {
                    $(this).text(messages[i]);
                  }
                });
              });
            }, 3000);
          },

          sendMessageButton: function () {
            $(".send").on("click", function (e) {
              var input = $(".draft");
              myChat.send(Chat.username + ": " + input.val());
              input.val("");
            });
          }

        };

        $.extend(myChat, coreChat);
        myChat.init();

      });

    </script>

    <h2>Borken Chat</h2>
    <input class="draft" type="text"/> <button class="send">send</button>
    <ul class="messages"></ul>
  </body>
</html>